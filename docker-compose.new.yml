version: '3.8'

services:
  # ============ 核心后端服务 (Langgraph版) ============
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend-core
    ports:
      - "8000:8000"  # Central Agent 入口
    env_file:
      - ./.env  # 读取 根目录下的 .env
    environment:
      # --- LLM 配置 ---
      - LLM_API_KEY=${LLM_API_KEY} 
      - LLM_BASE_URL=${LLM_BASE_URL}
      - LLM_MODEL=${LLM_MODEL:-gpt-4o-mini}
      - OPENAI_API_KEY=${OPENAI_API_KEY} 
      
      # --- 搜索配置 ---
      - SEARCH_PROVIDER=${SEARCH_PROVIDER:-tavily}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      
      # --- Embedding 模型 ---
      # 容器内路径，需要与下面的 volumes 对应
      - EMBEDDING_MODEL=/app/models/bge-large-zh-v1.5
      - HF_ENDPOINT=https://hf-mirror.com
      
      # --- Neo4j 配置 ---
      - NEO4J_URI=bolt://neo4j:7687 
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-password123}
      
      - KNOWLEDGE_ENGINE_URL=http://localhost:8000 

    volumes:
      # 1. 挂载数据目录 
      - ./backend/data:/app/data
      
      # 2. 挂载 LightRAG 工作目录 
      - ./backend/lightrag_workdir:/app/lightrag_workdir
      
      # 3. 挂载本地模型 
      # 要确保宿主机 ./backend/models/下存在bge模型
      - ./backend/models:/app/models
      
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

  # ============ Web前端 ============
  web-frontend:
    build: ./services/web-frontend
    container_name: web-frontend
    ports:
      - "3000:80"
    depends_on:
      - search-agent
      - knowledge-engine
    networks:
      - app-network
    restart: unless-stopped

  # ============ 基础设施：Neo4j 数据库 ============
  neo4j:
    image: neo4j:5.15.0 
    container_name: neo4j
    ports:
      - "7474:7474"  # HTTP Console
      - "7687:7687"  # Bolt 协议
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-password123}
      - NEO4J_dbms_memory_pagecache_size=512M
      # 开启 APOC 插件 
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - ./neo4j_data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u ${NEO4J_USER:-neo4j} -p ${NEO4J_PASSWORD:-password123} 'RETURN 1'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  # ============ 基础设施：Redis ============
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - app-network
    restart: unless-stopped

networks:
  app-network:
    driver: bridge