version: '3.8'

services:
  # ============ 模块A：搜索Agent服务 ============
  search-agent:
    build: ./services/search-agent
    container_name: search-agent
    ports:
      - "8001:8001"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - KNOWLEDGE_ENGINE_URL=http://knowledge-engine:8002
    depends_on:
      - knowledge-engine
    networks:
      - app-network
    restart: unless-stopped

  # ============ 模块B：LightRAG知识引擎 ============
  knowledge-engine:
    build: ./services/knowledge-engine
    container_name: knowledge-engine
    ports:
      - "8002:8002"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
    volumes:
      - ./data/lightrag_cache:/app/lightrag_cache
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

  # ============ 模块C：Web前端 ============
  web-frontend:
    build: ./services/web-frontend
    container_name: web-frontend
    ports:
      - "3000:80"
    depends_on:
      - search-agent
      - knowledge-engine
    networks:
      - app-network
    restart: unless-stopped

  # ============ 基础设施：Neo4j图数据库 ============
  neo4j:
    image: neo4j:5-community
    container_name: neo4j
    ports:
      - "7474:7474"  # HTTP Browser
      - "7687:7687"  # Bolt协议
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - ./data/neo4j_data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "${NEO4J_USER}", "-p", "${NEO4J_PASSWORD}", "RETURN 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============ 基础设施：Redis缓存（可选） ============
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - app-network
    restart: unless-stopped

networks:
  app-network:
    driver: bridge

volumes:
  neo4j_data:
  lightrag_cache:
