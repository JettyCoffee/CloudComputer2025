version: '3.8'

services:
  # ============ 后端服务：Central Agent (整合 Search Agent + Knowledge Engine) ============
  backend:
    build: ./backend
    container_name: backend
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      # HuggingFace 镜像
      - HF_ENDPOINT=https://hf-mirror.com
      
      # LLM 配置
      - LLM_API_KEY=${LLM_API_KEY}
      - LLM_BASE_URL=${LLM_BASE_URL}
      - LLM_MODEL=${LLM_MODEL:-deepseek-chat}
      
      # OpenAI 配置 (用于 Search Agent)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      
      # Tavily 配置 (用于网络搜索)
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      
      # Embedding 模型路径（挂载到容器内的路径）
      - EMBEDDING_MODEL=/app/models/bge-large-zh-v1.5
      
      # Neo4j 配置
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
    volumes:
      # 持久化数据目录
      - ./data/graphs:/app/data/graphs
      - ./data/documents:/app/data/documents
      - ./data/lightrag_workdir:/app/lightrag_workdir
      
      # 挂载 BGE Embedding 模型
      - ./services/knowledge-engine/bge-large-zh-v1.5:/app/models/bge-large-zh-v1.5:ro
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============ 前端服务：Web Frontend ============
  frontend:
    build: ./frontend
    container_name: frontend
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - app-network
    restart: unless-stopped

  # ============ 基础设施：Neo4j图数据库 ============
  neo4j:
    image: neo4j:5-community
    container_name: neo4j
    ports:
      - "7474:7474"  # HTTP Browser
      - "7687:7687"  # Bolt协议
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - ./data/neo4j_data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "${NEO4J_USER:-neo4j}", "-p", "${NEO4J_PASSWORD}", "RETURN 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============ 基础设施：Redis缓存（可选） ============
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - app-network
    restart: unless-stopped

networks:
  app-network:
    driver: bridge

volumes:
  neo4j_data:
  lightrag_cache:
